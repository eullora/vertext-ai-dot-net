<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="~/js/utils.js"></script>


<div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3">
    </div>
</div>

<script type="text/javascript">
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/notificationHub")
        .build();

    connection.on("ReceiveNotification", function (message) {
        console.log(message);
        var msgModel = JSON.parse(message);

        if(msgModel.Type =="chunk"){
            $('#link-' + msgModel.Id).attr('href', 'javascript:void(0);');
            $('#link-' + msgModel.Id).attr('title', 'Chunk ready. Initiated Pinecone indexing');

            if (msgModel.code == 0) {
                showToastMessage('Document chunking completed. Initiating Pinecone indexing..');
            }
            else {
                showToastMessage('Error in chunking.');
            }            
        }

        if(msgModel.Type =="pinecone"){
            $('#link-' + msgModel.Id).attr('title','Pinecone index ready');
            showToastMessage('Document indexing is completed in Pinecone..');
            $('#spin-' + msgModel.Id).remove();
        }

    });

    connection.start().catch(err => console.error(err.toString()));

    function showToastMessage(msg){
          var toastId = "toast-" + new Date().getTime(); 

            var toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${msg}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>`;

            $("#toastContainer").append(toastHtml);
            var toastElement = $("#" + toastId);
            var toast = new bootstrap.Toast(toastElement[0], { delay: 5000 });
            toast.show();
            toastElement.on("hidden.bs.toast", function () {
                toastElement.remove();
            });
    }

</script>